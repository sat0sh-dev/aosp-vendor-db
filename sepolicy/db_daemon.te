# Data Broker Daemon SELinux Policy
#
# Product partition module (OEM customization)
#
# This policy allows db_daemon to:
# - Run as a product daemon process
# - Create UDS sockets for daemon IPC (Phase 3.7: trust-based)
# - Create TCP/IP sockets for app IPC (Phase 3.6/3.7: token-based)
# - Load Hook library (dlopen) for authentication (Phase 3.6)
# - Write logs to logcat

# Type declarations
# Product partition requires: coredomain for domain, system_file_type for exec, core_data_file_type for data
type db_daemon, domain, coredomain, mlstrustedsubject;
type db_daemon_exec, exec_type, file_type, system_file_type;
type db_data_file, file_type, data_file_type, core_data_file_type, mlstrustedobject;

# Domain transition from init
init_daemon_domain(db_daemon)

# Note: Binary is labeled db_daemon_exec, domain transition via init_daemon_domain()

# Phase 3.7: UDS socket for daemon IPC (trust-based)
allow db_daemon self:unix_stream_socket { create bind listen accept read write getopt setopt shutdown };
allow db_daemon db_data_file:dir { create_dir_perms rw_dir_perms };
allow db_daemon db_data_file:sock_file { create setattr getattr unlink write };

# Phase 3.6/3.7: TCP/IP socket for app IPC (token-based)
allow db_daemon self:tcp_socket { create bind listen accept read write getopt setopt shutdown getattr };
allow db_daemon node:tcp_socket node_bind;
allow db_daemon port:tcp_socket name_bind;

# Allow logcat access for logging
allow db_daemon logd:unix_dgram_socket sendto;
allow db_daemon logdr_socket:sock_file write;

# Allow stdio_to_kmsg (stderr -> kmsg -> logcat)
allow db_daemon kmsg_debug_device:chr_file { write open };

# Phase 3.10: UDS communication from apps (experimental)
# Allow untrusted_app to connect to db_daemon via UDS
# This enables simpler authentication (UID-based) instead of Keystore Attestation
allow untrusted_app db_data_file:dir search;
allow untrusted_app db_data_file:sock_file write;
allow untrusted_app db_daemon:unix_stream_socket connectto;

# Phase 3.8/3.10: System Binder access for IPackageManagerNative
# Product partition with coredomain may access system binder (unlike vendor partition)
# This enables UID -> package name lookup for UDS authentication
binder_use(db_daemon)
binder_call(db_daemon, system_server)
allow db_daemon package_native_service:service_manager find;

# Phase 3.10: Read packages.list for UID -> package name mapping
# /data/system/packages.list is managed by PackageManagerService
allow db_daemon packages_list_file:file { open read getattr };
